<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
   <meta http-equiv="content-type" content="text/html; charset=utf-8" />
   <title>Ruby be nimble, Ruby be SWF...</title>
   <meta name="author" content="" />

   <!--- Blueprint CSS Framework -->
   <link rel="stylesheet" href="/css/blueprint/screen.css" type="text/css" media="screen, projection">
   <link rel="stylesheet" href="/css/blueprint/print.css" type="text/css" media="print">
   <!--[if IE]>
      <link rel="stylesheet" href="/css/blueprint/ie.css" type="text/css" media="screen, projection">
   <![endif]-->

   <!-- CodeRay syntax highlighting CSS -->
   <link rel="stylesheet" href="/css/coderay.css" type="text/css" />

   <!-- Homepage CSS -->
   <link rel="stylesheet" href="/css/site.css" type="text/css" media="screen, projection" />
</head>
<body>

<div class="container">

   <div class="column span-20 prepend-2 append-2 first last" id="header">
     <p class="title"><a href="/">JunctionBox.ca</a></p>
     <p><a href="/articles/">Articles</a> | <a href="/resources/">Resources</a> | <a href="/nathan-fisher.html">Contact</a></p>
     <hr/>
   </div>

   <div class="column span-15 prepend-2 first">
      <p>This is a quick post with notes on the <a href="http://www.adobe.com/devnet/swf/pdf/swf_file_format_spec_v9.pdf">SWF format</a>.  Well so far it&#8217;s only one really, and it is in reference to compression.</p>
<p>From page 13, 3rd paragraph in the documentation;</p>
<p class="quote">&#8220;The FileLength field is the total length of the SWF file, including the header. If this is an<br />
uncompressed SWF file (FWS signature), the FileLength field should exactly match the file<br />
size. If this is a compressed SWF file (CWS signature), the FileLength field indicates the total<br />
length of the file after decompression, and thus generally does not match the file size. Having<br />
the uncompressed size available can make the decompression process more efficient.&#8221;<br />
\nSeems pretty clear and straight forward, but it doesn&#8217;t really reference where the compression starts.  I initially assumed, that it starts at the end of the SWF header.  The end of the header seemed like a logical boundary to me. What I quickly found with <a href="http://www.suavetech.com/0xed/0xed.html">0xED</a> is that compression starts immediately after the 32-bit FileLength.  Okay so now we know, and knowing is half the battle! What next?</p>
<h3>Toes to the edge, and wait for the gun.</h3>
<p>Okay so we know that the compression starts <strong>after</strong> the length. How do we decompress it? Enter the standard Zlib library built-in to Ruby. It starts with a simple;</p>
<p><code>require 'zlib'</code></p>
<p>And requires the compressed contents in a string buffer like so;</p>
<pre>
def read_remaining_bytes
	pos = @file.tell
	@file.seek( 0, IO::SEEK_END )
	end_pos = @file.tell
	@file.pos = pos
	@file.read( end_pos - pos )
end
</pre>
<p>Note: @file is a file handle using File.new( filename, &#8216;r&#8217; ), it is assumed the position in the file is the first byte immediately after the SWF length attribute.  See SwfReader in <a href="http://junctionbox.ca/projects/ruby-swfer/">Ruby-Swfer</a> for further details.</p>
<h3>Inflate those water wings and kick!</h3>
<p>Okay we have our compressed content now lets inflate it!</p>
<pre>
def decompress( compressed_contents )
	zstream = Zlib::Inflate.new
	decompressed_contents = zstream.inflate( compressed_contents )
	zstream.finish
	zstream.close
	decompressed_contents
end
</pre>
<p>And voila, you should have all your bytes in a nice little (big) string. All you have left is to run through each byte and decode to your hearts content.</p>
   </div>

   <div class="column span-5 append-2 last">
      <div class="box">
      <h4>About JunctionBox.ca</h4>
      <p><a href="http://junctionbox.ca/">JunctionBox.ca</a> is the online blog of Nathan Fisher.  I'm a computer geek who loves the outdoors.  During the week you'll find me bridging the gap between developers and operations as a <a href="http://en.wikipedia.org/wiki/DevOps">DevOp</a> at ThoughtWorks, in London.</p>
      </div>

			<h5>Recent Articles</h5>
			<ul>

<li><a href="/articles/2008/09/04/ruby-be-nimble--ruby-be-swf---.html">Ruby be nimble, Ruby be SWF...</a></li>


<li><a href="/articles/2008/08/26/watch-for-flying-bitmaps.html">Watch for Flying Bitmaps</a></li>


<li><a href="/articles/2008/07/25/beware-the-garbage-man-s-scope.html">Beware the Garbage Man's Scope</a></li>


<li><a href="/articles/2008/07/04/regular-expression---parsed-elation.html">Regular Expression & Parsed Elation</a></li>


<li><a href="/articles/2008/06/26/scrollpane-woes-to-fix-the-flow.html">Scrollpane Woes to Fix the Flow</a></li>


<li><a href="/articles/2008/06/26/subversive-lyrics-with-subversion.html">Subversive Lyrics with Subversion</a></li>


<li><a href="/articles/2006/04/17/rsync-daily-snapshots.html">Rsync Daily Snapshots</a></li>

			</ul>
			

      <h5>Blog Roll</h5>
			<ul>
			<li><a href="http://dailyinteractive.ca/">DailyInteractive.ca</a></li>
			<li><a href="http://migz.ca/">Migz.ca</a></li>
			<li><a href="http://etlgfx.com/">ETL gfx</a></li>
			<li><a href="http://littlekitchen.ca/">Little Kitchen</a></li>
			<li><a href="http://matthewkantor.com/">Matthew Kantor</a></li>
			<li><a href="http://continuousdelivery.com/">Continous Delivery - Jez Humble</a></li>
			<li><a href="http://www.samnewman.org/">Sam Newman</a></li>
			</ul>
   </div>

   <div class="column span-20 prepend-2 append-2 first last" id="footer">
     <hr />
     <p><a href="/articles/">Articles</a> | <a href="/resources/">Resources</a> | <a href="/nathan-fisher.html">Contact</a> | All content written by Nathan Fisher unless otherwise noted.</p>
   </div>

</div>
</body>
</html>
